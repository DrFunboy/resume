<?xml version="1.0" encoding="utf-8"?>
<form>
  <AjaxForm>1</AjaxForm>
  <AllowedUsersGroups>ag::admin;, ag::broker;, ag::headBroker;</AllowedUsersGroups>
  <AllowedCapability>u::CAPABILITY_EDIT_EMPLOYEE_TASK;</AllowedCapability>
  <FormCaption>Перенести задачу</FormCaption>
  <FormID>postpone_modal</FormID>
  <GroupID>task_employee</GroupID>
  <Label>Перенести задачу</Label>
  <Name>postpone_modal</Name>
  <OnAjaxSubmitFunction>let formID = $('#client_task_tab').data('form-id');
reloadFormByID(formID);
$('.modal').modal('hide');</OnAjaxSubmitFunction>
  <PerPage>50</PerPage>
  <SQL>set @error = if('@CanPostpone;' = 0, 'Невозможно перенести задачу', '')
## 
UPDATE employee_task et
INNER JOIN employee_task_type ett 
  ON ett.TaskTypeID = et.TaskTypeID
SET
  et.DateEnd = et.DateEnd + INTERVAL ett.PostponeDays DAY,
  et.PostponeDays = ett.PostponeDays
WHERE et.TaskID = '@TaskID;'</SQL>
  <SQLselect>SELECT 
  (ett.PostponeDays != 0 AND et.PostponeDays = 0) AS CanPostpone,
  et.DateEnd + INTERVAL ett.PostponeDays DAY AS NextDateEnd,
  CONCAT('Дедлайн будет перенесен на ', et.DateEnd + INTERVAL ett.PostponeDays DAY, '. Продолжить ?') AS NextDateMsg
FROM employee_task et
INNER JOIN employee_task_type ett 
  ON ett.TaskTypeID = et.TaskTypeID
WHERE et.TaskID = '@TaskID;'</SQLselect>
  <SubmitBtn>1</SubmitBtn>
  <SubmitBtnName>Продолжить</SubmitBtnName>
  <Inputs>
    <FullWidth>1</FullWidth>
    <Name>NextDateMsg</Name>
    <Type>46</Type>
    <VisConditions>CanPostpone=1</VisConditions>
  </Inputs>
  <Inputs>
    <DefaultValue>Невозможно перенести задачу</DefaultValue>
    <FullWidth>1</FullWidth>
    <Name>ErrorMsg</Name>
    <Type>46</Type>
    <VisConditions>CanPostpone=0</VisConditions>
  </Inputs>
  <Inputs>
    <DefaultValue>@TaskID;</DefaultValue>
    <Name>TaskID</Name>
    <Type>47</Type>
  </Inputs>
  <Inputs>
    <Name>CanPostpone</Name>
    <Type>47</Type>
  </Inputs>
</form>
